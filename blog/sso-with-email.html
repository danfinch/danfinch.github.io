<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><title>Simple, Cheap Same Sign-On with Email - Dan Finch</title><meta name="darkreader-lock"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="shortcut icon" type="image/png" href="/favicon.png"><link rel="alternate" type="application/atom+xml" href="/feed.xml" title="Atom Feed"><link rel="alternate" type="application/json" href="/feed.json" title="JSON Feed"><style>:root{--background-body:#0d1117;--background:#161b22;--background-bright:rgba(240,246,252,0.15);--background-alt:#1a242f;--selection:#1c76c5;--text-main:#c9d1d9;--text-bright:#e3e9f0;--text-muted:#8b949e;--links:#e3bc5e;--focus:#388bfd;--focus-background:#0c2d6b;--border:#21252c;--border-muted:#21262d;--border-bright:#8b949e;--button-hover:#324759;--form-placeholder:#a9a9a9;--select-arrow:svg-load("./assets/select-arrow.svg",fill:#efefef);--monospace:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;--sans-serif:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue","Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji",sans-serif}html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,Segoe UI Emoji,Apple Color Emoji,Noto Color Emoji,sans-serif;font-family:var(--sans-serif);line-height:1.7;max-width:50rem;margin:6rem auto;padding:0 10px;word-wrap:break-word;color:#c9d1d9;color:var(--text-main);background:#0d1117;background:var(--background-body);text-rendering:optimizeLegibility}h1,h2,h3,h4,h5{margin:3rem 0 1.38rem;line-height:1.3}h1{font-size:2.488rem}h2{font-size:2.074rem}h3{font-size:1.728rem}h4{font-size:1.44rem}h5{font-size:1.2rem}h6{font-size:1rem}small{font-size:.833rem}h1,h2,h3,h4,h5,h6,strong{color:#e3e9f0;color:var(--text-bright)}blockquote{border-left:4px solid #388bfd;border-left:4px solid var(--focus);margin:1.5em 0;padding:0 1em}blockquote>:first-child{margin-top:0}blockquote>:last-child{margin-bottom:0}blockquote>footer{border:0}address{font-style:normal}a[href^=mailto\:]:before{content:"ðŸ“§ "}a[href^=tel\:]:before{content:"ðŸ“ž "}a[href^=sms\:]:before{content:"ðŸ’¬ "}mark{background-color:#e3bc5e;background-color:var(--links);border-radius:2px;padding:0 2px}ol,ul{padding-left:2em}aside{width:40%;padding-left:.5rem;margin-left:.5rem;float:right;border-left:2px solid #388bfd;border-left:2px solid var(--focus);font-style:italic}aside>p{margin:.5rem}button,input[type=button],input[type=checkbox],input[type=radio],input[type=range],input[type=reset],input[type=submit],select{cursor:pointer}input:not([type=checkbox]):not([type=radio]),select{display:block}input,select,textarea{color:#e3e9f0;color:var(--text-bright);background-color:#161b22;background-color:var(--background);font-family:inherit;font-size:inherit;margin-right:6px;margin-bottom:6px;padding:10px;border-radius:6px;outline:none;border:1px solid #21262d;border:1px solid var(--border-muted)}input[type=color]{min-height:2rem;padding:8px;cursor:pointer}input[type=checkbox],input[type=radio]{height:1.2em;width:1em}input[type=radio]{border-radius:100%}input{vertical-align:top}label{vertical-align:middle;margin-bottom:4px;display:inline-block}button,input:not([type=checkbox]):not([type=radio]),input[type=range],select,textarea{-webkit-appearance:none}textarea{display:block;margin-right:0;resize:vertical}textarea,textarea:not([cols]){width:100%}textarea:not([rows]){min-height:40px;height:140px}select{background:#161b22 svg-load("./assets/select-arrow.svg",fill:#efefef) calc(100% - 12px) 50%/12px no-repeat;background:var(--background) var(--select-arrow) calc(100% - 12px) 50%/12px no-repeat;padding-right:35px}select::-ms-expand{display:none}select[multiple]{padding-right:10px;background-image:none;overflow-y:auto}input:focus,select:focus,textarea:focus{border:1px solid #388bfd;border:1px solid var(--focus);box-shadow:0 0 0 3px #0c2d6b;box-shadow:0 0 0 3px var(--focus-background)}button:disabled,input:disabled,select:disabled,textarea:disabled{cursor:not-allowed;opacity:.5}::-moz-placeholder{color:#a9a9a9;color:var(--form-placeholder)}:-ms-input-placeholder{color:#a9a9a9;color:var(--form-placeholder)}::placeholder{color:#a9a9a9;color:var(--form-placeholder)}fieldset{border:1px solid #21252c;border:1px solid var(--border);border-radius:6px;margin:0 0 12px;padding:10px 20px}legend{font-size:.9em;font-weight:600}input[type=range]{margin:10px 0;padding:10px 0;background:transparent}input[type=range]:focus{outline:none}input[type=range]::-webkit-slider-runnable-track{width:100%;height:9.5px;-webkit-transition:.2s;transition:.2s;background:#161b22;background:var(--background);border-radius:3px}input[type=range]::-webkit-slider-thumb{box-shadow:0 1px 1px #000,0 0 1px #0d0d0d;height:20px;width:20px;border-radius:50%;background:#21252c;background:var(--border);-webkit-appearance:none;margin-top:-7px}input[type=range]:focus::-webkit-slider-runnable-track{background:#161b22;background:var(--background)}input[type=range]::-moz-range-track{width:100%;height:9.5px;-moz-transition:.2s;transition:.2s;background:#161b22;background:var(--background);border-radius:3px}input[type=range]::-moz-range-thumb{box-shadow:1px 1px 1px #000,0 0 1px #0d0d0d;height:20px;width:20px;border-radius:50%;background:#21252c;background:var(--border)}input[type=range]::-ms-track{width:100%;height:9.5px;background:transparent;border-color:transparent;border-width:16px 0;color:transparent}input[type=range]::-ms-fill-lower,input[type=range]::-ms-fill-upper{background:#161b22;background:var(--background);border:.2px solid #010101;border-radius:3px;box-shadow:1px 1px 1px #000,0 0 1px #0d0d0d}input[type=range]::-ms-thumb{box-shadow:1px 1px 1px #000,0 0 1px #0d0d0d;border:1px solid #000;height:20px;width:20px;border-radius:50%;background:#21252c;background:var(--border)}input[type=range]:focus::-ms-fill-lower,input[type=range]:focus::-ms-fill-upper{background:#161b22;background:var(--background)}a{text-decoration:none;color:#e3bc5e;color:var(--links)}a:hover{text-decoration:underline}code,samp,tt,var{font-size:85%;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-family:var(--monospace)}kbd{font-size:85%}code,kbd,samp,tt{padding:.2em .4em;border-radius:.4em}code,samp,tt{background:rgba(240,246,252,.15);background:var(--background-bright)}pre,pre>code{display:block;overflow-x:auto}pre>code{background:#161b22;background:var(--background);padding:1em}var{color:#388bfd;color:var(--focus);font-style:normal}kbd{border:1px solid #8b949e;border:1px solid var(--border-bright);font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-family:var(--monospace)}img,video{max-width:100%;height:auto}hr{border:none;border-top:1px solid #8b949e;border-top:1px solid var(--border-bright);margin:1em 0}table{border-collapse:collapse;margin-bottom:10px;width:100%;table-layout:fixed;overflow-x:auto;display:block}table caption,td,th{text-align:left}td,th{padding:6px;vertical-align:top;word-wrap:break-word}thead{border-bottom:1px solid #8b949e;border-bottom:1px solid var(--border-bright)}tfoot{border-top:1px solid #8b949e;border-top:1px solid var(--border-bright)}tbody tr:nth-child(2n){background-color:#161b22;background-color:var(--background)}tbody tr:nth-child(2n) button{background-color:#1a242f;background-color:var(--background-alt)}tbody tr:nth-child(2n) button:hover{background-color:#0d1117;background-color:var(--background-body)}::-moz-selection{background-color:#1c76c5;background-color:var(--selection);color:#e3e9f0;color:var(--text-bright)}::selection{background-color:#1c76c5;background-color:var(--selection);color:#e3e9f0;color:var(--text-bright)}details summary{padding:.5rem 0;border-top:1px solid #21252c;border-top:1px solid var(--border);cursor:pointer;font-size:1.2rem;outline:none}summary:focus,summary:hover{text-decoration:underline}dialog{background-color:#0d1117;background-color:var(--background-body);color:#c9d1d9;color:var(--text-main);border-radius:6px;border:1px solid #21252c;border:1px solid var(--border);padding:10px 30px}dialog>header:first-child{border-radius:6px 6px 0 0;margin:-10px -30px 10px;padding:10px;text-align:center;border-bottom:1px solid #21252c;border-bottom:1px solid var(--border)}dialog::-webkit-backdrop{background:rgba(0,0,0,.611764705882353);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}dialog::backdrop{background:rgba(0,0,0,.611764705882353);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}footer{border-top:1px solid #21252c;border-top:1px solid var(--border);padding-top:10px;color:#8b949e;color:var(--text-muted)}body>footer{margin-top:40px}@media print{body,button,code,details,input,pre,summary,textarea{background-color:#fff}button,input,textarea{border:1px solid #000}body,button,code,footer,h1,h2,h3,h4,h5,h6,input,pre,strong,summary,textarea{color:#000}summary::marker{color:#000}summary::-webkit-details-marker{color:#000}tbody tr:nth-child(2n){background-color:#f2f2f2}a{color:#00f;text-decoration:underline}}body nav:first-of-type{position:fixed;top:0;left:0;background:rgba(0,0,0,.5);padding:0 calc(50vw - 25rem);display:flex;align-items:center;width:100%;z-index:999}body nav:first-of-type:before{backdrop-filter:saturate(180%) blur(5px);-webkit-backdrop-filter:saturate(180%) blur(5px);content:"";position:absolute;z-index:-1;top:0;left:0;right:0;bottom:0}body nav:first-of-type #brand{margin-right:auto;font-size:1.1rem}body nav:first-of-type a{margin:10px;display:inline-block}body nav:first-of-type ul{list-style-type:none;margin:0;padding:0;overflow:hidden;display:inline}body nav:first-of-type>ul>li{float:left}body nav:first-of-type ul li ul{display:none;position:absolute;background:rgba(0,0,0,.5);-webkit-backdrop-filter:saturate(180%) blur(5px);backdrop-filter:saturate(180%) blur(5px)}body nav:first-of-type ul li:hover ul{display:block}section{margin:20px 0}article{border:1px solid #21252c;border:1px solid var(--border);padding:20px;margin:10px 0;border-radius:.4em}article>:first-child,article>:first-child>:first-child{margin-top:0}article>:last-child,article>:last-child>:last-child{margin-bottom:0}button,input[type=button],input[type=reset],input[type=submit]{background:rgba(240,246,252,.15);background:var(--background-bright);border:1px solid #30363d;color:#e3e9f0;color:var(--text-bright);font-family:inherit;font-size:inherit;margin-right:.5rem;margin-bottom:.5rem;padding:5px 16px;border-radius:6px;outline:none;font-size:87.5%}button:hover,input[type=button]:hover,input[type=reset]:hover,input[type=submit]:hover{border-color:#8b949e;filter:brightness(115%)}button:focus,input[type=button]:focus,input[type=reset]:focus,input[type=submit]:focus{border:1px solid #8b949e;box-shadow:none}button:active,input[type=button]:active,input[type=reset]:active,input[type=submit]:active{background:none}button:disabled,input[type=button]:disabled,input[type=reset]:disabled,input[type=submit]:disabled{border-color:#30363d}
/*# sourceMappingURL=bahunya.min.css.map */
</style><style>pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#e0e2e4;background:#282b2e}.hljs-keyword,.hljs-literal,.hljs-selector-id,.hljs-selector-tag{color:#93c763}.hljs-number{color:#ffcd22}.hljs-attribute{color:#668bb0}.hljs-link,.hljs-regexp{color:#d39745}.hljs-meta{color:#557182}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-emphasis,.hljs-name,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-subst,.hljs-tag,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable{color:#8cbbad}.hljs-string,.hljs-symbol{color:#ec7600}.hljs-comment,.hljs-deletion,.hljs-quote{color:#818e96}.hljs-selector-class{color:#a082bd}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-strong,.hljs-title,.hljs-type{font-weight:700}.hljs-class .hljs-title,.hljs-code,.hljs-section,.hljs-title.class_{color:#fff}</style><style>.brand{color:white;font-size:24px;font-weight:bold;margin-right:30px !important}.brand:hover{text-decoration:none}.social{float:right}main li{list-style-type:"âª§ "}</style></head><body><nav><a class="brand" href="/">Dan Finch</a><ul><li><a href="/">About</a></li><li><a href="/experience">Experience</a></li><li><a href="/tech">Tech</a></li><li><a href="/blog">Blog</a></li><li><a href="https://errilaz.org">Projects</a></li><li><a href="/contact">Contact</a></li></ul></nav><main><style>h1{margin-bottom:0}.navigate{display:flex;width:100%}.navigate .previous{flex:1}.navigate .next{flex:1;text-align:right}</style><h1>Simple, Cheap Same Sign-On with Email</h1><aside>Tags: <span><a href="/tags/sso.html">sso</a> </span><span><a href="/tags/self-hosted.html">self-hosted</a> </span></aside><div>by <a href="/">Dan</a> at 1/28/2023</div><hr><p>I don&#39;t have to tell anybody that managing multiple credentials for
multiple people is a pain. There are several single/same sign-on protocols
already, but most are very complicated or proprietary, with limited support.</p>
<p>When setting up a NextCloud for my family and personal use I just used my email
host as a source for same sign-on. I re-used this with a few self-hosted services
I run with Docker on AWS LightSail servers.</p>
<h2 id="email-hosting">Email Hosting</h2>
<p>Email sucks, but it&#39;s still usually a necessity. Running an email server is
notoriously touchy, so I&#39;ve opted to use <a href="https://www.namecheap.com/hosting/email/">NameCheap Private Email</a>.
It is very inexpensive, and I already use NameCheap for domain registration,
so it will automatically configure my domain records.</p>
<p>In addition to accounts for each family member, I added a <code>system@</code>
account for NextCloud and other utilities to be able to send notifications,
password resets, etc. without storing my personal password in each app.</p>
<h2 id="nextcloud">NextCloud</h2>
<p><a href="https://nextcloud.com">NextCloud</a> is an open source file sync platform
that includes an office suite as well as many other apps and integrations.
It has an official <a href="https://apps.nextcloud.com/apps/user_external">External user authentication</a>
app that supports IMAP.</p>
<p>After experimenting with setting up NextCloud manually with Docker, I
found an inexpensive managed host. I don&#39;t have to install, update, fix
issues, or back up manually, and even with the cost of this and email hosting
together, I&#39;m paying much less than the lowest tier Dropbox account, which only
gives me file sync, while NextCloud serves as a replacement for Google Workspace
or Office 365.</p>
<p>A few of the apps (Maps, Music, Talk) aren&#39;t really that great, but I have found Deck,
the Kanban project management tool, to be surprisingly good. I use it to plan
trips and keep track of complex bureaucratic processes. It integrates well with the
Calendar and Tasks apps, and I prefer it to most other dedicated Kanban tools.</p>
<p>After setting up NextCloud and adding the External user authentication app, I had
to manually edit the <code>nextcloud/config/config.php</code> file and add the following:</p>
<pre><code><span class="hljs-string">&#x27;user_backends&#x27;</span> =&gt; 
<span class="hljs-keyword">array</span> (
  <span class="hljs-number">0</span> =&gt; 
  <span class="hljs-keyword">array</span> (
    <span class="hljs-string">&#x27;class&#x27;</span> =&gt; <span class="hljs-string">&#x27;\OCA\UserExternal\IMAP&#x27;</span>,
    <span class="hljs-string">&#x27;arguments&#x27;</span> =&gt; 
    <span class="hljs-keyword">array</span> (
      <span class="hljs-number">0</span> =&gt; <span class="hljs-string">&#x27;mail.privateemail.com&#x27;</span>,
      <span class="hljs-number">1</span> =&gt; <span class="hljs-number">993</span>,
      <span class="hljs-number">2</span> =&gt; <span class="hljs-string">&#x27;ssl&#x27;</span>,
      <span class="hljs-number">3</span> =&gt; <span class="hljs-string">&#x27;&lt;my domain name here&gt;&#x27;</span>,
      <span class="hljs-number">4</span> =&gt; <span class="hljs-literal">true</span>,
      <span class="hljs-number">5</span> =&gt; <span class="hljs-literal">false</span>,
    ),
  ),
),</code></pre><h2 id="self-hosted-source-code">Self-Hosted Source Code</h2>
<p>Even though GitHub now has free private repositories, I like having my own
backup &amp; the ability to give clients private access without restriction. I
tested <a href="https://gitea.io/">Gitea</a>&#39;s SMTP authentication option and found it
to work great, but ended up going with <a href="https://gogs.io">Gogs</a> because it also
supports <a href="https://gogs.io/docs/features/authentication#smtp">SMTP authentication</a>
and works better with Docker. Both are great substitutes for GitHub.</p>
<p>For example, this is how I set up Gogs with NameCheap&#39;s server:</p>
<p><img src="images/gogs-smtp-authentication.png" alt="Gogs configuration"></p>
<h2 id="irc-hosting-and-pam-authentication">IRC Hosting and PAM Authentication</h2>
<p>I have a small, mostly unused IRC server which authenticates through my email
host as well. I&#39;m using <a href="https://ngircd.barton.de">ngIRCd</a>, which supports Linux
PAM. PAM has many modules, one of which (pam_exec) allows you to use a shell script
to do custom authentication. I used this to authenticate against my IMAP server.
I also wrote a Docker image to automate this:</p>
<pre><code><span class="hljs-keyword">FROM</span> alpine:<span class="hljs-number">3.16</span>

<span class="hljs-keyword">RUN</span><span class="language-bash"> apk --no-cache add curl autoconf automake pkgconfig \
  openssl make gcc g++ openssl-dev linux-pam-dev linux-pam</span>

<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /opt</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> \
  curl -L  https://github.com/ngircd/ngircd/archive/refs/tags/rel-26.1.tar.gz -o ngircd.tgz &amp;&amp; \
  tar xvf ngircd.tgz &amp;&amp; \
  <span class="hljs-built_in">mv</span> /opt/ngircd-rel-26.1 /opt/ngircd</span>

<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /opt/ngircd</span>
<span class="hljs-keyword">RUN</span><span class="language-bash"> \
  ./autogen.sh &amp;&amp; \
  ./configure --with-openssl --with-pam &amp;&amp; \
  make &amp;&amp; \
  make install</span>

<span class="hljs-keyword">RUN</span><span class="language-bash"> \
  apk del curl autoconf automake pkgconfig make gcc g++ \
  openssl-dev linux-pam-dev</span>

<span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /scripts</span>

<span class="hljs-keyword">RUN</span><span class="language-bash"> \
  <span class="hljs-built_in">rm</span> /opt/ngircd.tgz &amp;&amp; \
  <span class="hljs-built_in">rm</span> -rf /opt/ngircd</span>

<span class="hljs-keyword">COPY</span><span class="language-bash"> scripts /scripts</span>
<span class="hljs-keyword">COPY</span><span class="language-bash"> etc/pam.d /etc/pam.d</span>

<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">6667</span>
<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">6697</span>

<span class="hljs-keyword">VOLUME</span><span class="language-bash"> [<span class="hljs-string">&quot;/config/ngircd&quot;</span>]</span>

<span class="hljs-keyword">CMD</span><span class="language-bash"> [ <span class="hljs-string">&quot;/scripts/start.sh&quot;</span> ]</span></code></pre><p>Since the environment variables I set in my <code>docker-compose.yaml</code> aren&#39;t
available within PAM, the <code>start.sh</code> script stores them:</p>
<pre><code><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">printenv</span> &gt; /scripts/environment
ngircd -f /config/ngircd/ngircd.conf -n</code></pre><p>The <code>auth.sh</code> script can then retrieve the environment variables and use <code>openssl</code>
to login to the IMAP server and check the credentials:</p>
<pre><code><span class="hljs-meta">#!/bin/sh</span>
IMAP_PASSWORD=`<span class="hljs-built_in">cat</span> -`
<span class="hljs-built_in">source</span> /scripts/environment
IMAP_LOG=$(openssl s_client -quiet -crlf -connect <span class="hljs-string">&quot;<span class="hljs-variable">$IMAP_HOST</span>:<span class="hljs-variable">$IMAP_PORT</span>&quot;</span> &lt;&lt;<span class="hljs-string">EOF
A1 LOGIN $PAM_USER $IMAP_PASSWORD
A2 LOGOUT
EOF</span>
)
<span class="hljs-keyword">if</span> <span class="hljs-built_in">echo</span> <span class="hljs-variable">$IMAP_LOG</span> | grep <span class="hljs-string">&quot;A1 OK&quot;</span> - &gt; /dev/null; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">exit</span> 0
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 1  </code></pre><p>The <code>/etc/pam.d/ngircd</code> config file tells PAM how to use this:</p>
<pre><code>auth required pam_exec.so stdout expose_authtok log=/var/log/pam_exec.log /scripts/auth.sh</code></pre><p>The only step after this is to make sure <code>PAM = yes</code> in the <code>[Options]</code> section
of <code>ngircd.conf</code>.</p>
<p>This can be used for any of the many servers and apps that support PAM
authentication.</p>
<p>I&#39;ve published the Docker image at <a href="https://hub.docker.com/r/errilaz/emauth-ngircd">errilaz/emauth-ngircd</a>
and source code is on <a href="https://github.com/errilaz/emauth/tree/master/images/ngircd">GitHub</a>.</p>
<h2 id="other-bridges">Other Bridges</h2>
<p>Some servers also support hitting an HTTP proxy or SSH daemon to verify
credentials. It would be trivial to bridge these methods to IMAP in the
same way as the bash script above. This opens up the possibility
of using this simple, cheap same sign-on with tons of software.</p>
<p>You could use a full IMAP library to achieve this, but as the OpenSSL
example shows, it is very simple with a TLS socket. I have tested this 
TypeScript code and plan to use it for any other bridges I create in the
future (which I will share).</p>
<p>I&#39;ve also published this on <a href="https://www.npmjs.com/package/emauth-authenticate">NPM</a>
and <a href="https://github.com/errilaz/emauth/tree/master/libraries/authenticate">GitHub</a>.</p>
<pre><code><span class="hljs-keyword">import</span> tls <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;tls&quot;</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CRLF</span> = <span class="hljs-string">&quot;\r\n&quot;</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">authenticate</span>(<span class="hljs-params">host: <span class="hljs-built_in">string</span>, port: <span class="hljs-built_in">number</span>, username: <span class="hljs-built_in">string</span>, password: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> socket = tls.<span class="hljs-title function_">connect</span>({ host, port, <span class="hljs-attr">servername</span>: host })

    <span class="hljs-keyword">let</span> response = <span class="hljs-string">&quot;&quot;</span>

    socket.<span class="hljs-title function_">once</span>(<span class="hljs-string">&quot;secureConnect&quot;</span>, connect)
    socket.<span class="hljs-title function_">once</span>(<span class="hljs-string">&quot;end&quot;</span>, disconnect)
    socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;data&quot;</span>, receive)
    socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;error&quot;</span>, error)

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params"></span>) {
      socket.<span class="hljs-title function_">write</span>(<span class="hljs-string">`A01 LOGIN <span class="hljs-subst">${username}</span> <span class="hljs-subst">${password}</span><span class="hljs-subst">${CRLF}</span>`</span>)
      socket.<span class="hljs-title function_">write</span>(<span class="hljs-string">`A02 LOGOUT<span class="hljs-subst">${CRLF}</span>`</span>)
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">receive</span>(<span class="hljs-params">data: Buffer</span>) {
      response += data.<span class="hljs-title function_">toString</span>()
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"></span>) {
      socket.<span class="hljs-title function_">off</span>(<span class="hljs-string">&quot;data&quot;</span>, receive)
      <span class="hljs-title function_">resolve</span>(<span class="hljs-regexp">/^A01 OK/gm</span>.<span class="hljs-title function_">test</span>(response))
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">error</span>(<span class="hljs-params">error: <span class="hljs-built_in">any</span></span>) {
      socket.<span class="hljs-title function_">off</span>(<span class="hljs-string">&quot;data&quot;</span>, receive)
      <span class="hljs-title function_">reject</span>(error)
    }
  })
}</code></pre><hr><div class="navigate"><div class="previous">Previous: <a href="/blog/pocketpress-ssg.html">Introducing PocketPress SSG</a></div></div></main><footer>Powered by <a href="https://github.com/errilaz/pocketpress">PocketPress</a> | <a href="https://github.com/danfinch/danfinch.github.io">Source Code</a><div class="social"><a href="https://www.linkedin.com/in/danfinch/"><svg height="24" viewBox="0 0 72 72" width="24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" fill="#007EBB"/><path d="M62,62 L51.315625,62 L51.315625,43.8021149 C51.315625,38.8127542 49.4197917,36.0245323 45.4707031,36.0245323 C41.1746094,36.0245323 38.9300781,38.9261103 38.9300781,43.8021149 L38.9300781,62 L28.6333333,62 L28.6333333,27.3333333 L38.9300781,27.3333333 L38.9300781,32.0029283 C38.9300781,32.0029283 42.0260417,26.2742151 49.3825521,26.2742151 C56.7356771,26.2742151 62,30.7644705 62,40.051212 L62,62 Z M16.349349,22.7940133 C12.8420573,22.7940133 10,19.9296567 10,16.3970067 C10,12.8643566 12.8420573,10 16.349349,10 C19.8566406,10 22.6970052,12.8643566 22.6970052,16.3970067 C22.6970052,19.9296567 19.8566406,22.7940133 16.349349,22.7940133 Z M11.0325521,62 L21.769401,62 L21.769401,27.3333333 L11.0325521,27.3333333 L11.0325521,62 Z" fill="#FFF"/></g></svg></a></div></footer></body></html>